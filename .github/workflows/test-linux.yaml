name: Test Linux

on: [push, pull_request, merge_group]

concurrency:
  # Cancel previous workflows of the same PR, but only for PRs
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  TEST: "spin test -- --config-file ${{ github.workspace }}/pyproject.toml"
  PYTEST: "pytest --config-file ${{ github.workspace }}/pyproject.toml"

jobs:
  # GH does not support creating separate jobs out of a matrix,
  # so this is a workaround
  build-linux-311:
    uses: ./.github/workflows/_build_linux_for_python_x.yaml
    with:
      python-version: 3.11

  build-linux-312:
    uses: ./.github/workflows/_build_linux_for_python_x.yaml
    with:
      python-version: 3.12

  build-linux-313:
    uses: ./.github/workflows/_build_linux_for_python_x.yaml
    with:
      python-version: 3.13

  test-linux-311:
    name: test-linux-cp3.11-${{ matrix.OPTIONS_NAME }}
    needs: [build-linux-311]
    strategy:
      matrix:
        # Dependency options for setup-test-env.sh
        OPTIONS_NAME: ["main"]
        MINIMUM_REQUIREMENTS: [0]
        OPTIONAL_DEPS: [0]
        WITHOUT_POOCH: [0]
        PIP_FLAGS: [""]

        include:
          - MINIMUM_REQUIREMENTS: 1
            OPTIONAL_DEPS: 0
            EAGER_IMPORT: 1
            OPTIONS_NAME: "mini-req-eager-import"
          - MINIMUM_REQUIREMENTS: 1
            OPTIONAL_DEPS: 1
            OPTIONS_NAME: "mini-req-optional-deps"
    uses: ./.github/workflows/_test_linux_for_python_x.yaml
    with:
      MINIMUM_REQUIREMENTS: ${{ matrix.MINIMUM_REQUIREMENTS }}
      OPTIONAL_DEPS: ${{ matrix.OPTIONAL_DEPS }}
      EAGER_IMPORT: ${{ matrix.EAGER_IMPORT }}
      WITHOUT_POOCH: ${{ matrix.WITHOUT_POOCH }}
      PIP_FLAGS: ${{ matrix.PIP_FLAGS }}

  test-linux-312:
    name: test-linux-cp3.12-${{ matrix.OPTIONS_NAME }}
    needs: [build-linux-312]
    strategy:
      matrix:
        # Dependency options for setup-test-env.sh
        OPTIONS_NAME: ["main"]
        MINIMUM_REQUIREMENTS: [0]
        OPTIONAL_DEPS: [0]
        WITHOUT_POOCH: [0]
        PIP_FLAGS: [""]

        include:
          - PIP_FLAGS: "--pre"
            OPTIONS_NAME: "pre"
          - OPTIONAL_DEPS: 1
            OPTIONS_NAME: "optional-deps"
          - PYTHONOPTIMIZE: 2
            WITHOUT_POOCH: 1
            OPTIONS_NAME: "optimize-and-no-pooch"

    uses: ./.github/workflows/_test_linux_for_python_x.yaml
    with:
      MINIMUM_REQUIREMENTS: ${{ matrix.MINIMUM_REQUIREMENTS }}
      OPTIONAL_DEPS: ${{ matrix.OPTIONAL_DEPS }}
      EAGER_IMPORT: ${{ matrix.EAGER_IMPORT }}
      WITHOUT_POOCH: ${{ matrix.WITHOUT_POOCH }}
      PIP_FLAGS: ${{ matrix.PIP_FLAGS }}
      PYTHONOPTIMIZE: ${{ matrix.PYTHONOPTIMIZE }}

  test-linux-313:
    name: test-linux-cp3.13-${{ matrix.OPTIONS_NAME }}
    needs: [build-linux-313]
    strategy:
      matrix:
        # Dependency options for setup-test-env.sh
        OPTIONS_NAME: ["main"]
        MINIMUM_REQUIREMENTS: [0]
        OPTIONAL_DEPS: [0]
        WITHOUT_POOCH: [0]
        PIP_FLAGS: [""]

    uses: ./.github/workflows/_test_linux_for_python_x.yaml
    with:
      MINIMUM_REQUIREMENTS: ${{ matrix.MINIMUM_REQUIREMENTS }}
      OPTIONAL_DEPS: ${{ matrix.OPTIONAL_DEPS }}
      EAGER_IMPORT: ${{ matrix.EAGER_IMPORT }}
      WITHOUT_POOCH: ${{ matrix.WITHOUT_POOCH }}
      PIP_FLAGS: ${{ matrix.PIP_FLAGS }}
      PYTHONOPTIMIZE: ${{ matrix.PYTHONOPTIMIZE }}
